# nix-homelab
NixOS homelab

## Hosts

This page generated by `inv doc-generate`

[comment]: (>>HOSTS)

<table>
    <tr>
        <th>Logo</th>
        <th>Name</th>
        <th>IP</th>
        <th>Description</th>
    </tr><tr>
        <td><a href="./docs/hosts/box.md"><img width="32" src="https://logos-marques.com/wp-content/uploads/2022/03/SFR-Logo-1994.png"></a></td>
        <td><a href="./docs/hosts/box.md">box</a></td>
        <td>192.168.0.1</td>
        <td>SFR internet box</td>
    </tr><tr>
        <td><a href="./docs/hosts/router-ext.md"><img width="32" src="https://cdn.shopify.com/s/files/1/0653/8759/3953/files/512.png?v=1657867177&width=32"></a></td>
        <td><a href="./docs/hosts/router-ext.md">router-ext</a></td>
        <td>192.168.0.10</td>
        <td>External home mikrotik router</td>
    </tr><tr>
        <td><a href="./docs/hosts/router-int.md"><img width="32" src="https://cdn.shopify.com/s/files/1/0653/8759/3953/files/512.png?v=1657867177&width=32"></a></td>
        <td><a href="./docs/hosts/router-int.md">router-int</a></td>
        <td>192.168.254.254</td>
        <td>Internal home mikrotik router</td>
    </tr><tr>
        <td><a href="./docs/hosts/latino.md"><img width="32" src="https://styles.redditmedia.com/t5_6sciw0/styles/communityIcon_h3cvittvupi91.png"></a></td>
        <td><a href="./docs/hosts/latino.md">latino</a></td>
        <td>192.168.254.152</td>
        <td>Dell Latitude E5540 Latop</td>
    </tr><tr>
        <td><a href="./docs/hosts/rpi40.md"><img width="32" src="https://upload.wikimedia.org/wikipedia/fr/thumb/3/3b/Raspberry_Pi_logo.svg/32px-Raspberry_Pi_logo.svg.png"></a></td>
        <td><a href="./docs/hosts/rpi40.md">rpi40</a></td>
        <td>192.168.0.17</td>
        <td>The Raspberry PI 4 storage server</td>
    </tr><tr>
        <td><a href="./docs/hosts/bootstore.md"><img width="32" src="https://simpleicons.org/icons/databricks.svg"></a></td>
        <td><a href="./docs/hosts/bootstore.md">bootstore</a></td>
        <td>192.168.0.99</td>
        <td>HP Proliant Microserver N40L storage server</td>
    </tr></table>

[comment]: (<<HOSTS)

## Install from scratch

Boot from NixOS live cd

```
# Change keymap & root password
sudo -i
loadkeys fr
passwd 

# WI-FI
systemctl start wpa_supplicant
wpa_cli
add_network
set_network 0 ssid "ssid_name"
set_network 0 psk "password"
enable_network 0

# From other computer, enter to deploy environment
# NOTE: Use <SPACE> before command for not storing command in bash history (for secure your passwords)
nix develop
ssh-copy-id root@<nixos-livecd-ip>
 inv firmware-tpi-update --hosts <nixos-livecd-ip> 
 inv disk-format --hosts <nixos-livecd-ip> --disks /dev/sda --password <zfspassword>
inv ssh-init-host-key --hosts <nixos-livecd-ip> --hostnames <hostname>

# Add password key to ./hosts/<hostname>/secrets.yml 
echo 'yourpassword' | mkpasswd -m sha-512 -s

# Re-encrypt all keys for the previous host
sops updatekeys ./hosts/<hostname>/secrets.yml

####################################################
# Execute your custom task here, exemple:
# - Restore persist borgbackup
# - Configure some program (private key generation)
####################################################

# install
inv install-nixos --hosts <nixos-livecd-ip> --flakeattr <hostname>
```


## Folders

[comment]: (>>FOLDERS)

```
.
├── configurations.nix
├── docs
│   └── hosts
│       ├── bootstore.md
│       ├── box.md
│       ├── host.tpl
│       ├── latino.lstopo.svg
│       ├── latino.md
│       ├── router-ext.md
│       ├── router-int.md
│       ├── rpi40.lstopo.svg
│       └── rpi40.md
├── flake.lock
├── flake.nix
├── homelab.json
├── hosts
│   ├── rpi40
│   │   ├── default.nix
│   │   ├── secrets.yml
│   │   ├── ssh_host_ed25519_key.pub
│   │   ├── ssh_host_rsa_key.pub
│   │   └── ssh-to-age.txt
│   └── secrets.yml
├── LICENSE
├── modules
│   ├── hardware
│   │   └── rpi4-usb-boot.nix
│   ├── system
│   │   ├── hosts.nix
│   │   ├── networking.nix
│   │   ├── nfs
│   │   │   └── server.nix
│   │   ├── nix.nix
│   │   ├── nix-serve.nix
│   │   ├── sshd.nix
│   │   └── zfs.nix
│   └── users.nix
├── README.md
├── tasks.py
└── vscode.code-workspace

```


[comment]: (<<FOLDERS)


# A big thanks ❤️

A big thank to the contributors of OpenSource projects in particular :
- [doctor-cluster-config](https://github.com/TUM-DSE/doctor-cluster-config) from German TUM School of Computation
- [Mic92](https://github.com/Mic92/dotfiles) and for his some nix contributions
- [Misterio77](https://github.com/Misterio77/nix-config) and for his some nix contributions