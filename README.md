# nix-homelab
NixOS homelab

## Hosts

This page generated by `inv doc-generate`

[comment]: (>>HOSTS)

<table>
    <tr>
        <th>Logo</th>
        <th>Name</th>
        <th>IP</th>
        <th>Description</th>
    </tr><tr>
        <td><a href="./docs/hosts/box.md"><img width="32" src="https://logos-marques.com/wp-content/uploads/2022/03/SFR-Logo-1994.png"></a></td>
        <td><a href="./docs/hosts/box.md">box</a></td>
        <td>192.168.0.1</td>
        <td>SFR internet box</td>
    </tr><tr>
        <td><a href="./docs/hosts/router-ext.md"><img width="32" src="https://cdn.shopify.com/s/files/1/0653/8759/3953/files/512.png?v=1657867177&width=32"></a></td>
        <td><a href="./docs/hosts/router-ext.md">router-ext</a></td>
        <td>192.168.0.10</td>
        <td>External home mikrotik router</td>
    </tr><tr>
        <td><a href="./docs/hosts/router-int.md"><img width="32" src="https://cdn.shopify.com/s/files/1/0653/8759/3953/files/512.png?v=1657867177&width=32"></a></td>
        <td><a href="./docs/hosts/router-int.md">router-int</a></td>
        <td>192.168.254.254</td>
        <td>Internal home mikrotik router</td>
    </tr><tr>
        <td><a href="./docs/hosts/sam.md"><img width="32" src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/Xfce_logo-footprint.svg/32px-Xfce_logo-footprint.svg.png"></a></td>
        <td><a href="./docs/hosts/sam.md">sam</a></td>
        <td>192.168.0.18</td>
        <td>Samsung N110 Latop</td>
    </tr><tr>
        <td><a href="./docs/hosts/latino.md"><img width="32" src="https://styles.redditmedia.com/t5_6sciw0/styles/communityIcon_h3cvittvupi91.png"></a></td>
        <td><a href="./docs/hosts/latino.md">latino</a></td>
        <td>192.168.254.152</td>
        <td>Dell Latitude E5540 Latop</td>
    </tr><tr>
        <td><a href="./docs/hosts/rpi40.md"><img width="32" src="https://upload.wikimedia.org/wikipedia/fr/thumb/3/3b/Raspberry_Pi_logo.svg/32px-Raspberry_Pi_logo.svg.png"></a></td>
        <td><a href="./docs/hosts/rpi40.md">rpi40</a></td>
        <td>192.168.0.17</td>
        <td>The Raspberry PI 4 storage server</td>
    </tr><tr>
        <td><a href="./docs/hosts/bootstore.md"><img width="32" src="https://simpleicons.org/icons/databricks.svg"></a></td>
        <td><a href="./docs/hosts/bootstore.md">bootstore</a></td>
        <td>192.168.0.29</td>
        <td>HP Proliant Microserver N40L storage server</td>
    </tr></table>

[comment]: (<<HOSTS)

## Commons scratch installation

Boot from NixOS live cd

```
##########################################################
# NixOS installation configuration
##########################################################

# Change keymap & root password
sudo -i
loadkeys fr
passwd 

# From other computer, enter to deploy environment
# NOTE: Use <SPACE> before command for not storing command in bash history (for secure your passwords)
nix develop
export TARGETIP=<hostip>
export TARGETNAME=<hostname>

ssh-copy-id root@${TARGETIP}
 inv disk-format --hosts ${TARGETIP} --disk /dev/sda --mirror /dev/sdb --mode MBR
 [Optional] inv disk-mount --hosts ${TARGETIP} --mirror true --password "<zfspassword>"
inv ssh-init-host-key --hosts ${TARGETIP} --hostnames ${TARGETNAME}
inv nixos-generate-config --hosts ${TARGETIP} --hostnames ${TARGETNAME} --name hp-proliant-microserver-n40l

# Add hosts/bootstore/ssh-to-age.txt content to .sops.yaml
# Add root password key to ./hosts/bootstore/secrets.yml 
echo 'yourpassword' | mkpasswd -m sha-512 -s

# Re-encrypt all keys for the previous host
sops updatekeys ./hosts/${TARGETNAME}/secrets.yml

####################################################
# Execute your custom task here, exemple:
# - Restore persist borgbackup
# - Configure some program (private key generation)
####################################################

# Add hostname in configurations.nix with minimalModules
# Configure hosts/<hostname>/default.nix

# NixOS installation
inv nixos-install --hosts ${TARGETIP} --flakeattr ${TARGETNAME}
```

## Update nixos

```
inv deploy --hosts bootstore
```


## Folders

[comment]: (>>FOLDERS)

```
.
├── configurations.nix
├── docs
│   └── hosts
│       ├── bootstore.lstopo.svg
│       ├── bootstore.md
│       ├── box.md
│       ├── host.tpl
│       ├── latino.lstopo.svg
│       ├── latino.md
│       ├── router-ext.md
│       ├── router-int.md
│       ├── rpi40.lstopo.svg
│       ├── rpi40.md
│       └── sam.md
├── flake.lock
├── flake.nix
├── homelab.json
├── hosts
│   ├── bootstore
│   │   ├── default.nix
│   │   ├── secrets.yml
│   │   ├── ssh_host_ed25519_key.pub
│   │   ├── ssh_host_rsa_key.pub
│   │   └── ssh-to-age.txt
│   ├── rpi40
│   │   ├── default.nix
│   │   ├── secrets.yml
│   │   ├── ssh_host_ed25519_key.pub
│   │   ├── ssh_host_rsa_key.pub
│   │   └── ssh-to-age.txt
│   ├── sam
│   │   ├── default.nix
│   │   ├── secrets.yml
│   │   ├── ssh_host_ed25519_key.pub
│   │   ├── ssh_host_rsa_key.pub
│   │   └── ssh-to-age.txt
│   └── secrets.yml
├── LICENSE
├── modules
│   ├── hardware
│   │   ├── hp-proliant-microserver-n40l.nix
│   │   ├── rpi4-usb-boot.nix
│   │   └── samsung-n210.nix
│   ├── system
│   │   ├── hosts.nix
│   │   ├── networking.nix
│   │   ├── nfs
│   │   │   └── server.nix
│   │   ├── nix.nix
│   │   ├── nix-serve.nix
│   │   ├── sshd.nix
│   │   └── zfs.nix
│   └── users.nix
├── README.md
├── tasks.py
└── vscode.code-workspace

```


[comment]: (<<FOLDERS)


# A big thanks ❤️

A big thank to the contributors of OpenSource projects in particular :
- [doctor-cluster-config](https://github.com/TUM-DSE/doctor-cluster-config) from German TUM School of Computation
- [Mic92](https://github.com/Mic92/dotfiles) and for his some nix contributions
- [Misterio77](https://github.com/Misterio77/nix-config) and for his some nix contributions