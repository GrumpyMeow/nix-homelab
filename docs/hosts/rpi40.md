# RPI40

This page generated by `inv doc-generate`

## Hardware information

[comment]: (>>HOSTINFOS)


### Services

| Port | Service | Product | Extra info |
| ------ | ------ |------ |------ |
|22|ssh|OpenSSH|protocol 2.0|
|5000|upnp|||


    
### Topologie


![hardware topology](rpi40.lstopo.svg)

    
### Hardwares

```
System:
  Host: rpi40 Kernel: 5.15.74 aarch64 bits: 64 compiler: gcc v: 9.5.0 Console: N/A 
  Distro: NixOS 23.05 (Stoat) 
Machine:
  Type: ARM Device System: Raspberry Pi 4 Model B Rev 1.4 details: BCM2835 rev: d03114 
  serial: 10000000e3399f44 
Memory:
  RAM: total: 7.62 GiB used: 2.07 GiB (27.2%) 
  RAM Report: smbios: No SMBIOS data for dmidecode to process 
PCI Slots:
  ARM: No ARM data found for this feature. 
CPU:
  Info: Quad Core model: N/A variant: cortex-a72 bits: 64 type: MCP arch: ARMv8 rev: 3 
  features: Use -f option to see features bogomips: 432 
  Speed: 600 MHz min/max: 600/1500 MHz Core speeds (MHz): 1: 600 2: 600 3: 600 4: 600 
Graphics:
  Device-1: bcm2708-fb driver: bcm2708_fb v: kernel bus-ID: N/A chip-ID: brcm:soc class-ID: fb 
  Device-2: bcm2711-hdmi0 driver: N/A bus-ID: N/A chip-ID: brcm:soc class-ID: hdmi 
  Device-3: bcm2711-hdmi1 driver: N/A bus-ID: N/A chip-ID: brcm:soc class-ID: hdmi 
  Display: server: No display server data found. Headless machine? tty: N/A 
  Message: Advanced graphics data unavailable in console for root. 
Audio:
  Device-1: bcm2711-hdmi0 driver: N/A bus-ID: N/A chip-ID: brcm:soc class-ID: hdmi 
  Device-2: bcm2711-hdmi1 driver: N/A bus-ID: N/A chip-ID: brcm:soc class-ID: hdmi 
Network:
  Device-1: bcm2835-mmc driver: mmc_bcm2835 v: N/A port: N/A bus-ID: N/A chip-ID: brcm:fe300000 
  class-ID: mmcnr 
  IF: wlan0 state: down mac: dc:a6:32:f0:05:17 
  Device-2: bcm2711-genet-v5 driver: bcmgenet v: N/A port: N/A bus-ID: N/A chip-ID: brcm:fd580000 
  class-ID: ethernet 
  IF: end0 state: up speed: 1000 Mbps duplex: full mac: dc:a6:32:f0:05:16 
  IP v4: 192.168.0.17/24 type: dynamic noprefixroute scope: global broadcast: 192.168.0.255 
  WAN IP: 81.64.117.68 
RAID:
  Device-1: zroot type: zfs status: ONLINE level: linear size: 464 GiB free: 458 GiB 
  allocated: 5.66 GiB 
  Components: Online: N/A 
Drives:
  Local Storage: total: raw: 495.48 GiB usable: 959.48 GiB used: 3.06 GiB (0.3%) 
  ID-1: /dev/mmcblk0 vendor: SanDisk model: SL32G size: 29.72 GiB rotation: SSD serial: 0xc45a2427 
  scheme: MBR 
  ID-2: /dev/sda type: USB vendor: Hitachi model: HTS547550A9E384 size: 465.76 GiB 
  rotation: 5400 rpm serial: J2120052CA0MLA rev: JE3O scheme: GPT 
Partition:
  ID-1: / size: 444.05 GiB used: 44.1 MiB (0.0%) fs: zfs logical: zroot/private/root 
  ID-2: /boot size: 1022 MiB used: 107.5 MiB (10.5%) fs: vfat dev: /dev/sda1 
Swap:
  Alert: No swap data was found. 
Sensors:
  System Temperatures: cpu: 61.8 C mobo: N/A 
  Fan Speeds (RPM): N/A 
Info:
  Processes: 208 Uptime: 21:45:04  up 3 days 10:43,  1 user,  load average: 0.17, 0.06, 0.01 
  Init: systemd v: 252 target: multi-user.target Compilers: gcc: 9.5.0 Packages: nix-sys: 318 
  Client: Sudo v: 1.9.12p1 inxi: 3.3.04 

```

    

[comment]: (<<HOSTINFOS)


## Install from scratch

Download RPI image `https://hydra.nixos.org/build/201124221`

```
# Change keymap & root password
sudo -i
loadkeys fr
passwd 

# WI-FI
systemctl start wpa_supplicant
wpa_cli
add_network
set_network 0 ssid "ssid_name"
set_network 0 psk "password"
enable_network 0

# From other computer, enter to deploy environment
# NOTE: Use <SPACE> before command for not storing command in bash history (for secure your passwords)
nix develop
ssh-copy-id root@<nixos-livecd-ip>
 inv firmware-tpi-update --hosts <nixos-livecd-ip> 
 inv disk-format --hosts <nixos-livecd-ip> --disks /dev/sda --password <zfspassword>
inv ssh-init-host-key --hosts <nixos-livecd-ip> --hostnames <hostname>

# Add password key to ./hosts/<hostname>/secrets.yml 
echo 'yourpassword' | mkpasswd -m sha-512 -s

# Re-encrypt all keys for the previous host
sops updatekeys ./hosts/<hostname>/secrets.yml

# configure nix-server
inv init-nix-server --hosts <nixos-livecd-ip>
export DIR_NIXSERVE=/persist/host/data/nix-serve
mkdir -p $DIR_NIXSERVE && cd $DIR_NIXSERVE  
nix-store --generate-binary-cache-key rpi40.adele.local cache-priv-key.pem cache-pub-key.pem

# Update RPI and configure USB boot
inv firmware-rpi-update --hosts <nixos-livecd-ip>

# install
inv install-nixos --hosts <nixos-livecd-ip> --flakeattr <hostname>

```

## Second install
```

```

## nix-serve
```
nix verify --store http://localhost:5000 --trusted-public-keys 'rpi40.adele.local:JYE85lTt2SBXUwueEftHLH/CE7INzV0zH7TWfNtIqYU=' /nix/store
```